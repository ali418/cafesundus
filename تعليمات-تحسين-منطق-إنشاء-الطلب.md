# تعليمات تحسين منطق إنشاء الطلب

## المشكلة

عند إنشاء طلب جديد، تظهر رسالة خطأ:

```
ERROR: null value in column "id" of relation "customers" violates not-null constraint
```

السبب هو أن عمود `id` في جدول `customers` غير مهيأ للتوليد التلقائي (auto-increment) في قاعدة البيانات PostgreSQL على Railway.

## الحلول المقدمة

### 1. إصلاح قاعدة البيانات

قمنا بإنشاء عدة أدوات لإصلاح قاعدة البيانات:

- **سكريبت SQL محسن**: `backend/src/scripts/fix-customers-table.sql`
  - يضيف خاصية `IDENTITY` إلى عمود `id` في جدول `customers`
  - يتضمن اختبار للتأكد من عمل التوليد التلقائي

- **سكريبت Node.js**: `backend/fix-railway-db.js`
  - يمكن تشغيله مباشرة على Railway
  - يتحقق من حالة عمود `id` ويضيف خاصية `IDENTITY` إذا لم تكن موجودة

- **فحص تلقائي**: تم إضافته في `backend/src/index.js`
  - يقوم بإصلاح المشكلة عند بدء تشغيل الخادم

### 2. تحسين منطق إنشاء الطلب

قمنا بإنشاء نسخة محسنة من وظيفة `createOrderWithImage` في ملف `backend/src/controllers/order.controller.optimized.js` تتبع التسلسل المنطقي الصحيح:

1. **البحث عن العميل أو إنشاؤه أولاً**
   - استخدام `findOrCreate` للتأكد من وجود العميل قبل إنشاء الطلب
   - التحقق من وجود العميل فعلياً في قاعدة البيانات

2. **معالجة الصورة**
   - حفظ الصورة التي تم استلامها
   - التحقق من وجود صورة إيصال للدفع عبر الهاتف المحمول

3. **إنشاء الطلب**
   - إنشاء سجل المبيعة (`Sale`) باستخدام معرف العميل الصحيح
   - إنشاء عناصر المبيعة (`SaleItems`)
   - إنشاء إشعار بالطلب الجديد

## كيفية تطبيق الحلول

### 1. إصلاح قاعدة البيانات

#### الطريقة الأسرع:

1. افتح لوحة تحكم Railway
2. انتقل إلى قاعدة البيانات PostgreSQL
3. افتح وحدة تحكم SQL
4. نفذ الأمر التالي:

```sql
ALTER TABLE customers 
ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
```

#### أو استخدام السكريبت المحسن:

1. افتح لوحة تحكم Railway
2. انتقل إلى قاعدة البيانات PostgreSQL
3. افتح وحدة تحكم SQL
4. انسخ والصق محتوى ملف `backend/src/scripts/fix-customers-table.sql`
5. نفذ السكريبت

### 2. تطبيق النسخة المحسنة من وظيفة إنشاء الطلب

لتطبيق النسخة المحسنة من وظيفة `createOrderWithImage`:

1. افتح ملف `backend/src/controllers/order.controller.js`
2. استبدل وظيفة `createOrderWithImage` الحالية بالنسخة المحسنة من ملف `backend/src/controllers/order.controller.optimized.js`
3. تأكد من إضافة أي متغيرات أو استيرادات مفقودة في بداية الملف

## التحقق من الإصلاح

بعد تنفيذ الإصلاحات، يمكنك التحقق من نجاح الإصلاح بتنفيذ الاستعلام التالي في وحدة تحكم SQL:

```sql
SELECT is_identity, column_default 
FROM information_schema.columns 
WHERE table_schema = 'public' 
AND table_name = 'customers' 
AND column_name = 'id';
```

يجب أن تكون قيمة `is_identity` هي `YES`.

## اختبار الإصلاح

بعد تنفيذ الإصلاحات، جرب إنشاء طلب جديد من واجهة المستخدم. يجب أن يعمل بدون أخطاء.

## بخصوص مشكلة التوكن (Error 401: Not authorized)

هذه مشكلة منفصلة تخص **الـ Frontend**. عندما تقوم بعمل طلب `GET` لجلب بيانات طلب معين، يجب أن تضيف التوكن إلى الـ "Headers" الخاص بالطلب:

```javascript
const token = localStorage.getItem('token'); // أو من أي مكان حفظته فيه

axios.get('https://cafesundus.up.railway.app/api/v1/orders/101375617', { 
  headers: { 
    'Authorization': `Bearer ${token}` // <--- هذا هو الحل 
  } 
}); 
```

أنت لا تحتاج هذا التوكن لـ "إنشاء" طلب (لأن أي زائر يمكنه إنشاء طلب)، لكنك تحتاجه لـ "عرض" الطلبات (لأن المدير أو الموظف فقط من يجب أن يراها).