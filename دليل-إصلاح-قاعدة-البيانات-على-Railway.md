# دليل إصلاح قاعدة البيانات على Railway

## المشكلة

عند إنشاء طلب جديد، تظهر رسالة خطأ:

```
ERROR: null value in column "id" of relation "customers" violates not-null constraint
```

السبب هو أن عمود `id` في جدول `customers` غير مهيأ للتوليد التلقائي (auto-increment) في قاعدة البيانات PostgreSQL على Railway.

## الحلول المتاحة

### الحل 1: تنفيذ سكريبت SQL مباشرة في وحدة تحكم Railway

هذه هي الطريقة الأسرع والأكثر مباشرة:

1. افتح لوحة تحكم Railway
2. انتقل إلى قاعدة البيانات PostgreSQL
3. افتح وحدة تحكم SQL
4. انسخ والصق السكريبت التالي:

```sql
-- التحقق من وجود جدول customers وإضافة IDENTITY إلى عمود id
DO $$
DECLARE
    is_identity_enabled BOOLEAN;
    has_sequence BOOLEAN;
    column_default TEXT;
BEGIN
    -- التحقق من وجود جدول customers
    IF EXISTS (
        SELECT FROM information_schema.tables 
        WHERE table_schema = 'public' 
        AND table_name = 'customers'
    ) THEN
        RAISE NOTICE 'جدول العملاء موجود';
        
        -- التحقق من حالة عمود id
        SELECT 
            c.is_identity = 'YES',
            c.column_default,
            c.column_default LIKE '%nextval%'
        INTO 
            is_identity_enabled,
            column_default,
            has_sequence
        FROM 
            information_schema.columns c
        WHERE 
            c.table_schema = 'public' 
            AND c.table_name = 'customers' 
            AND c.column_name = 'id';
            
        RAISE NOTICE 'حالة عمود id الحالية:';
        RAISE NOTICE 'is_identity: %', CASE WHEN is_identity_enabled THEN 'YES' ELSE 'NO' END;
        RAISE NOTICE 'column_default: %', column_default;
        RAISE NOTICE 'has_sequence: %', CASE WHEN has_sequence THEN 'YES' ELSE 'NO' END;
        
        -- إصلاح العمود إذا لم يكن مهيأ بالفعل
        IF NOT is_identity_enabled AND NOT has_sequence THEN
            RAISE NOTICE 'جاري إضافة IDENTITY إلى عمود id...';
            
            ALTER TABLE customers 
            ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
            
            RAISE NOTICE 'تم إضافة IDENTITY إلى عمود id بنجاح';
        ELSE
            RAISE NOTICE 'عمود id مهيأ بالفعل، لا حاجة للتعديل';
        END IF;
    ELSE
        RAISE NOTICE 'جدول العملاء غير موجود!';
    END IF;
END $$;
```

5. انقر على زر "تنفيذ" أو "Run"

### الحل 2: تشغيل سكريبت Node.js على Railway

1. افتح لوحة تحكم Railway
2. انتقل إلى خدمة التطبيق (Backend)
3. افتح وحدة تحكم Shell
4. قم بإنشاء ملف جديد:

```bash
cd backend
nano fix-railway-db.js
```

5. انسخ والصق محتوى ملف `backend/fix-railway-db.js` الذي قمنا بإنشائه
6. احفظ الملف (Ctrl+O ثم Enter ثم Ctrl+X)
7. قم بتشغيل السكريبت:

```bash
node fix-railway-db.js
```

### الحل 3: إعادة تشغيل الخادم على Railway

قمنا بإضافة فحص تلقائي في `backend/src/index.js` يقوم بإصلاح المشكلة عند بدء تشغيل الخادم. يمكنك ببساطة إعادة تشغيل الخادم على Railway وسيتم إصلاح المشكلة تلقائيًا.

1. افتح لوحة تحكم Railway
2. انتقل إلى خدمة التطبيق (Backend)
3. انقر على زر "إعادة التشغيل" أو "Restart"

## التحقق من الإصلاح

بعد تنفيذ أحد الحلول، يمكنك التحقق من نجاح الإصلاح بتنفيذ الاستعلام التالي في وحدة تحكم SQL:

```sql
SELECT is_identity, column_default 
FROM information_schema.columns 
WHERE table_schema = 'public' 
AND table_name = 'customers' 
AND column_name = 'id';
```

يجب أن تكون قيمة `is_identity` هي `YES`.

## اختبار الإصلاح

بعد تنفيذ الإصلاح، جرب إنشاء طلب جديد من واجهة المستخدم. يجب أن يعمل بدون أخطاء.

## ملاحظات إضافية

- تأكد من أن لديك نسخة احتياطية من قاعدة البيانات قبل تنفيذ أي تغييرات.
- إذا كنت تستخدم خدمة استضافة أخرى غير Railway، قد تختلف خطوات الإصلاح قليلاً.
- إذا استمرت المشكلة، تحقق من سجلات الخادم للحصول على مزيد من المعلومات.