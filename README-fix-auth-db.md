# Cafe Sundus – Fix Guide (DB Auto-Increment + 401 Auth)

This guide provides practical, step-by-step instructions to resolve two issues:
- Database error: `null value in column "id" violates not-null constraint`
- 401 Unauthorized: `Not authorized, no token provided`

It includes SQL commands, backend/ frontend code references, and test steps.

---

## 1) Database: Make `customers.id` auto-increment

Problem: `customers.id` is not auto-incrementing. New rows fail because `id = NULL`.

Fix directly in PostgreSQL (Railway):

1. Open Railway → your project → PostgreSQL → “Connect” → SQL Console.
2. Run this SQL:

```sql
ALTER TABLE customers
ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
```

If it errors (e.g., due to legacy column setup), run the fallback sequence approach:

```sql
CREATE SEQUENCE IF NOT EXISTS customers_id_seq;

ALTER TABLE customers
ALTER COLUMN id SET DEFAULT nextval('customers_id_seq');

ALTER SEQUENCE customers_id_seq OWNED BY customers.id;
```

Validation:
- Insert a customer (via app or Postman) and confirm `id` generates as `1, 2, 3, ...`.
- If you have a migration `20250115000000-alter-customers-id-to-integer.js`, ensure production runs it or apply SQL manually.

References:
- `backend/src/models/customer.js` (primary key type is `INTEGER`)
- `backend/src/database/migrations/20250115000000-alter-customers-id-to-integer.js`

---

## 2) Frontend: Send JWT in Authorization header

Problem: Protected endpoints require a JWT in the `Authorization` header. Missing token yields 401.

Backend middleware expectation (already implemented):
- `backend/src/middleware/auth.js`
- Extracts token from `Authorization: Bearer <token>` and validates.

Frontend fix:
- Ensure your API client sends the token for protected routes.
- If using Axios, set the header:

```javascript
import axios from 'axios';

const token = localStorage.getItem('userToken');

const response = await axios.get('/api/v1/orders/101375617', {
  headers: {
    Authorization: `Bearer ${token}`,
  },
});
```

Persist token on login:

```javascript
// After successful login
localStorage.setItem('userToken', response.data.token);
```

Notes:
- The frontend already has an Axios instance with interceptors (`frontend/src/services/apiService.js`). Prefer using it so headers and base URL remain consistent.
- Development routes may use `mockAuth` and not require a token (e.g., `POST /api/v1/customers/api/find-or-create`).

---

## 3) Testing the fix

Run backend tests:

```bash
cd backend
npm test
```

Add or run a test for customer creation (`POST /api/v1/customers/api/find-or-create`) that mocks the `Customer` model. Expected behavior:
- If a matching email or phone exists → returns existing.
- Otherwise → creates and returns new customer.

---

## 4) Deployment notes (Railway)

- Railway deploy command: `cd backend && npm start` (`railway.json`). It does NOT auto-run migrations.
- To apply schema changes automatically, either:
  - Add a startup routine to run specific `ALTER TABLE` statements safely, or
  - Trigger `npm run db:migrate` via a deploy hook or manual execution.
- Production DB config: `backend/src/config/database.js` uses `DATABASE_URL` with SSL.

---

## Quick Arabic Version (نسخة عربية مختصرة)

### مشكلة قاعدة البيانات (الـ id لا يتولد تلقائياً)
- سبب: عمود `id` في جدول `customers` ما عنده auto-increment.
- الحل (في Railway / PostgreSQL):

```sql
ALTER TABLE customers
ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
```

أو إذا ظهر خطأ:

```sql
CREATE SEQUENCE IF NOT EXISTS customers_id_seq;
ALTER TABLE customers ALTER COLUMN id SET DEFAULT nextval('customers_id_seq');
ALTER SEQUENCE customers_id_seq OWNED BY customers.id;
```

اختبار: أضف عميل جديد وتأكد أن `id` صار 1، 2، 3...

### مشكلة 401 (Not authorized, no token provided)
- سبب: الواجهة الأمامية ما بتضيف التوكن في الـ header.
- الحل (React):

```javascript
const token = localStorage.getItem('userToken');
axios.get('/api/v1/orders/101375617', {
  headers: { Authorization: `Bearer ${token}` },
});
```

وقت تسجيل الدخول، احفظ التوكن:

```javascript
localStorage.setItem('userToken', response.data.token);
```

### ملاحظات للنشر (Railway)
- الأمر: `cd backend && npm start` وما فيه `db:migrate` تلقائيًا.
- نفّذ الـ SQL يدويًا أو أضف خطوة migrations عند البدء.

---

## Appendix: Paths & Files
- API base: `app.use('/api/v1', routes)` → requests like `/api/v1/...`
- Customers route: `POST /api/v1/customers/api/find-or-create` (uses `mockAuth`)
- Auth middleware: `backend/src/middleware/auth.js`
- DB models/ init: `backend/src/models/index.js`, `backend/src/db.js`
- Migrations: `backend/src/database/migrations/*`
- Railway config: `railway.json`